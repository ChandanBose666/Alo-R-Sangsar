---
import allProducts from "../data/products.json";

interface Props {
  products?: any[];
  title?: string;
  showSaleModal?: boolean;
}

const { 
  products = allProducts, 
  title, 
  showSaleModal = false 
} = Astro.props;

// Create a unique ID for this instance's carousels
const instanceId = Math.random().toString(36).substring(2, 9);

// Create carousel sets of 5 products (Desktop)
const itemsPerSlideDesktop = 5;
const slidesDesktop = [];
for (let i = 0; i < products.length; i += itemsPerSlideDesktop) {
  slidesDesktop.push(products.slice(i, i + itemsPerSlideDesktop));
}

// Create carousel sets of 3 products (Tablet)
const itemsPerSlideTablet = 3;
const slidesTablet = [];
for (let i = 0; i < products.length; i += itemsPerSlideTablet) {
  slidesTablet.push(products.slice(i, i + itemsPerSlideTablet));
}
---

<div class="container mx-auto px-4 py-12">
  {title && (
    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold text-gray-900 mb-2">{title}</h2>
      <div class="w-20 h-1 bg-black mx-auto"></div>
    </div>
  )}

  {showSaleModal && (
    <!-- Sale Modal -->
    <div
      id="sale-modal"
      class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4"
    >
      <div
        class="bg-white rounded-lg shadow-2xl max-w-sm w-full relative p-8 transform transition-all scale-95 opacity-0 duration-300"
        id="sale-modal-content"
      >
        <button
          id="close-modal"
          class="absolute top-4 right-4 text-gray-400 hover:text-black transition-colors"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="text-center">
          <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
             <svg class="w-10 h-10 text-orange-600" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M5.8 11.3 2 22l10.7-3.8L5.8 11.3Z" />
                <path d="m4 18 8.5-8.5" />
                <path d="M11 5v.01" />
                <path d="M11 2v.01" />
                <path d="M16 4v.01" />
                <path d="M9 10v.01" />
                <path d="M16 10v.01" />
                <path d="M21 7v.01" />
                <path d="M13 13.5a2 2 0 0 1 0-3" />
                <path d="M17.5 15a2 2 0 0 1 0-3" />
             </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">ðŸŽ‰ Congratulations!</h3>
          <p class="text-gray-600">You've unlocked a special <b>New Year Discount</b> for this artistic piece!</p>
        </div>
      </div>
    </div>
  )}

  <!-- Desktop Carousel (5 columns) -->
  <div id={`desktop-carousel-${instanceId}`} class="desktop-carousel-container hidden xl:block relative group mb-12" data-instance={instanceId}>
    <div class="relative overflow-hidden min-h-[620px]">
      <div class="relative w-full h-full">
        {
          slidesDesktop.map((slideProducts) => (
            <div data-slide class="absolute inset-0 transition-opacity duration-500 ease-in-out grid grid-cols-5 gap-6 p-2 opacity-0">
              {slideProducts.map((product) => (
                <div class="flex flex-col h-full bg-white group/card">
                  <a href={`/products/${product.id}`} class="relative aspect-[4/5] rounded-lg overflow-hidden mb-4 block group/img">
                    {product.badge && (
                      <span class="absolute top-3 left-3 bg-black text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider z-10">
                        {product.badge}
                      </span>
                    )}
                    <button class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition-colors z-10" onclick="event.preventDefault()">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    </button>
                    <img src={product.imageUrl} alt={product.title} class="w-full h-full object-contain mix-blend-multiply transition-transform duration-500 group-hover/img:scale-105" />
                  </a>

                  <div class="flex flex-col flex-grow">
                    <a href={`/products/${product.id}`} class="hover:text-black">
                      <h3 class="text-sm font-medium text-gray-800 line-clamp-2 mb-1 min-h-[40px]">{product.title}</h3>
                    </a>
                    
                    <div class="flex items-center gap-0.5 mb-2">
                      {[...Array(5)].map(() => (
                        <svg class="w-3 h-3 text-green-500 fill-current" viewBox="0 0 20 20">
                          <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                        </svg>
                      ))}
                      <span class="text-[10px] text-gray-400 ml-1">(1)</span>
                    </div>

                    <div class="mb-2">
                      <span data-sale-badge class="inline-block border border-red-500 text-red-500 text-[10px] font-bold px-2 py-0.5 rounded uppercase cursor-pointer hover:bg-red-50 transition-colors">
                        Sale
                      </span>
                    </div>

                    <div class="mt-auto">
                      <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-lg font-bold text-gray-900">â‚¹{product.price.toFixed(2)}</span>
                        <span class="text-sm text-gray-400 line-through">â‚¹{product.originalPrice.toFixed(2)}</span>
                      </div>
                      <p class="text-xs text-red-600 font-semibold mb-4">
                        Save â‚¹{(product.originalPrice - product.price).toFixed(2)} ({product.discount})
                      </p>
                      <button class="w-full bg-black text-white py-3 text-xs font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors rounded-sm">
                        Add to Basket
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ))
        }
      </div>
    </div>

    <!-- Controls Container -->
    <div class="flex items-center justify-between mt-8 px-2">
      <div class="flex gap-2">
        {
          slidesDesktop.map((_, index) => (
            <button data-dot class="w-2.5 h-2.5 rounded-full bg-gray-300 transition-all hover:bg-gray-400" aria-label={`Go to slide ${index + 1}`} />
          ))
        }
      </div>
      <div class="flex gap-1">
        <button data-prev class="border border-gray-200 hover:border-gray-900 p-2 transition-colors rounded-sm">
          <svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
        </button>
        <button data-next class="border border-gray-200 hover:border-gray-900 p-2 transition-colors rounded-sm">
          <svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Tablet Carousel (3 columns) -->
  <div id={`tablet-carousel-${instanceId}`} class="tablet-carousel-container hidden md:block xl:hidden relative group mb-12" data-instance={instanceId}>
    <div class="relative overflow-hidden min-h-[580px]">
      <div class="relative w-full h-full">
        {
          slidesTablet.map((slideProducts) => (
            <div data-slide class="absolute inset-0 transition-opacity duration-500 ease-in-out grid grid-cols-3 gap-6 p-2 opacity-0">
              {slideProducts.map((product) => (
                <div class="flex flex-col h-full bg-white group/card">
                  <a href={`/products/${product.id}`} class="relative aspect-[4/5] rounded-lg overflow-hidden mb-4 block group/img">
                    <span class="absolute top-3 left-3 bg-black text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase z-10">Offer</span>
                    <button class="absolute top-3 right-3 text-gray-400" onclick="event.preventDefault()">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    </button>
                    <img src={product.imageUrl} alt={product.title} class="w-full h-full object-contain mix-blend-multiply transition-transform duration-500 group-hover/img:scale-105" />
                  </a>
                  <div class="flex flex-col flex-grow">
                    <a href={`/products/${product.id}`} class="hover:underline">
                      <h3 class="text-sm font-medium text-gray-800 line-clamp-2 mb-1 min-h-[40px]">{product.title}</h3>
                    </a>
                    <div class="flex items-center gap-0.5 mb-2">
                      {[...Array(5)].map(() => (
                        <svg class="w-3 h-3 text-green-500 fill-current" viewBox="0 0 20 20">
                          <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                        </svg>
                      ))}
                      <span class="text-[10px] text-gray-400 ml-1">(1)</span>
                    </div>
                    <div class="mb-2">
                      <span data-sale-badge class="border border-red-500 text-red-500 text-[10px] font-bold px-2 py-0.5 rounded uppercase cursor-pointer hover:bg-red-50 transition-colors">Sale</span>
                    </div>
                    <div class="mt-auto">
                      <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-lg font-bold text-gray-900">â‚¹{product.price.toFixed(2)}</span>
                        <span class="text-sm text-gray-400 line-through">â‚¹{product.originalPrice.toFixed(2)}</span>
                      </div>
                      <p class="text-xs text-red-600 font-semibold mb-4">Save â‚¹{(product.originalPrice - product.price).toFixed(2)}</p>
                      <button class="w-full bg-black text-white py-3 text-xs font-bold uppercase tracking-widest rounded-sm">Add to Basket</button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ))
        }
      </div>
    </div>
    <div class="flex items-center justify-between mt-8 px-2">
      <div class="flex gap-2">
        {
          slidesTablet.map((_, index) => (
            <button data-dot class="w-2.5 h-2.5 rounded-full bg-gray-300 transition-all hover:bg-gray-400" aria-label={`Go to slide ${index + 1}`} />
          ))
        }
      </div>
      <div class="flex gap-1">
        <button data-prev class="border border-gray-200 p-2 rounded-sm"><svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
        <button data-next class="border border-gray-200 p-2 rounded-sm"><svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
      </div>
    </div>
  </div>

  <!-- Mobile Carousel (1 column) -->
  <div id={`mobile-carousel-${instanceId}`} class="mobile-carousel-container md:hidden relative group" data-instance={instanceId}>
    <div class="relative overflow-hidden min-h-[550px]">
      <div class="relative w-full h-full">
        {
          products.map((product) => (
            <div data-slide class="absolute inset-0 transition-opacity duration-500 ease-in-out p-2 opacity-0 flex justify-center">
              <div class="w-full max-w-[300px] flex flex-col bg-white">
                <a href={`/products/${product.id}`} class="relative aspect-[4/5] rounded-lg overflow-hidden mb-4 block group/img w-full">
                  <span class="absolute top-3 left-3 bg-black text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase z-10">Offer</span>
                  <img src={product.imageUrl} alt={product.title} class="w-full h-full object-contain mix-blend-multiply transition-transform duration-500 group-hover/img:scale-105" />
                </a>
                <a href={`/products/${product.id}`}>
                    <h3 class="text-sm font-medium text-gray-800 line-clamp-2 mb-1 text-center">{product.title}</h3>
                </a>
                <div class="flex items-center justify-center gap-0.5 mb-2">
                  {[...Array(5)].map(() => (
                    <svg class="w-2.5 h-2.5 text-green-500 fill-current" viewBox="0 0 20 20">
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                    </svg>
                  ))}
                  <span class="text-[8px] text-gray-400 ml-1">(1)</span>
                </div>
                <div class="flex items-baseline gap-2 mb-1">
                  <span class="text-lg font-bold text-gray-900">â‚¹{product.price.toFixed(2)}</span>
                  <span class="text-xs text-gray-400 line-through">â‚¹{product.originalPrice.toFixed(2)}</span>
                </div>
                <p class="text-[10px] text-red-600 font-semibold mb-4">Save â‚¹{(product.originalPrice - product.price).toFixed(2)}</p>
                <button class="w-full bg-black text-white py-3 text-xs font-bold uppercase tracking-widest rounded-sm">Add to Basket</button>
              </div>
            </div>
          ))
        }
      </div>
    </div>
    <div class="flex items-center justify-between mt-8 px-2">
      <div class="flex gap-2 flex-wrap justify-center max-w-[70%]">
        {
          products.map((_, index) => (
            <button data-dot class="w-2 h-2 rounded-full bg-gray-300 transition-all hover:bg-gray-400" aria-label={`Go to image ${index + 1}`} />
          ))
        }
      </div>
      <div class="flex gap-1">
        <button data-prev class="border border-gray-200 p-2 rounded-sm"><svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
        <button data-next class="border border-gray-200 p-2 rounded-sm"><svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
      </div>
    </div>
  </div>
</div>

<script src="../scripts/image-grid.ts"></script>
